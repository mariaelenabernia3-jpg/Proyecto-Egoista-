<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Mauricio</title>
    <!-- Enlace al CSS específico de Isagi -->
    <link rel="stylesheet" href="isagi_dashboard_style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="header">
        <div class="position-display">POSICIÓN: <span id="pos-val">--</span></div>
        <div class="profile-area">
            <div class="profile-icon" id="profileIcon">
                <img src="" id="img-preview" class="profile-pic-preview" style="display: none;">
                <i class="fas fa-user profile-default-icon" id="default-icon"></i> 
            </div>
            <div class="profile-popup" id="profilePopup">
                <h3>MAURICIO</h3>
                <p>Contraseña: 11</p>
                <p class="profile-level">Nivel: <span id="lvl-val">0</span></p>
                <!-- OFERTA (BID) DE MAURICIO -->
                <p class="profile-bid-popup" id="bid-val">BID: $0</p>
                <div class="xp-bar-container">
                    <div class="xp-bar-fill" id="xp-bar" style="width: 0%;"></div>
                    <span class="xp-text" id="xp-text">0/100 XP</span>
                </div>
                <div class="profile-pic-uploader">
                    <label for="profilePicInput" class="upload-button"><i class="fas fa-camera"></i> Cambiar Foto</label>
                    <input type="file" id="profilePicInput" accept="image/*" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <main class="main-content">
        <div class="dashboard-center-content">
            <h1>BIENVENIDO MAURICIO</h1>
            <div class="action-bubbles-container">
                <a href="isagi_missions.html" class="action-bubble">MISIONES</a>
                <a href="isagi_stats.html" class="action-bubble">ESTADÍSTICAS</a>
                <div class="action-bubble" id="leaderboardBtn">LEADERBOARD</div>
            </div>
        </div>
    </main>

    <!-- MODAL DE LEADERBOARD DINÁMICO -->
    <div class="coming-soon-modal" id="leaderboardModal">
        <div class="leaderboard-modal-content">
            <span class="close-button" id="closeLeaderboard">&times;</span>
            <h3 class="leaderboard-title">CLASIFICACIÓN GLOBAL</h3>
            <div id="modalList"></div>
        </div>
    </div>

    <!-- SCRIPTS DE FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // CONFIGURACIÓN ÚNICA DE ISAGI
        const myId = "Isagi"; 

        const firebaseConfig = {
            apiKey: "AIzaSyDSyHDZzCzqtDfQ7AvtP7or0Lz81HO3A88",
            authDomain: "bluelock-proyecto.firebaseapp.com",
            databaseURL: "https://bluelock-proyecto-default-rtdb.firebaseio.com",
            projectId: "bluelock-proyecto",
            storageBucket: "bluelock-proyecto.firebasestorage.app",
            messagingSenderId: "780939191248",
            appId: "1:780939191248:web:0ba0c191005a7870488fd5",
            measurementId: "G-XE8F4KS1CJ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // FUNCIÓN PARA SINCRONIZAR DATOS EN TIEMPO REAL
        function syncData() {
            db.ref('players').on('value', (snapshot) => {
                const players = snapshot.val();
                if (!players) return;
                const me = players[myId];

                // 1. Cargar Foto de Perfil
                if (me.img) {
                    const imgUrl = me.img.startsWith('data') ? me.img : '../' + me.img;
                    document.getElementById('img-preview').src = imgUrl;
                    document.getElementById('img-preview').style.display = 'block';
                    document.getElementById('default-icon').style.display = 'none';
                    document.getElementById('profileIcon').style.backgroundImage = `url(${imgUrl})`;
                    document.getElementById('profileIcon').style.backgroundSize = 'cover';
                }

                // 2. Cargar Datos Numéricos (BID, Nivel, XP)
                document.getElementById('bid-val').textContent = "BID: $" + me.bid.toLocaleString();
                document.getElementById('lvl-val').textContent = me.level;
                document.getElementById('xp-bar').style.width = me.xp + "%";
                document.getElementById('xp-text').textContent = me.xp + "/100 XP";

                // 3. Calcular Posición y Modal
                const sorted = Object.values(players).sort((a, b) => b.matchStats.g - a.matchStats.g || b.matchStats.pg - a.matchStats.pg);
                
                // Posición actual de Mauricio
                document.getElementById('pos-val').textContent = sorted.findIndex(p => p.id === myId) + 1;

                // Dibujar tabla del Leaderboard en el Modal
                document.getElementById('modalList').innerHTML = sorted.map((p, index) => {
                    const position = index + 1;
                    const rankDisplay = (position === 1) ? `<i class="fas fa-crown crown-icon"></i>` : position;

                    return `
                        <div class="player-row" style="${p.id === myId ? 'border-left: 5px solid gold;' : ''}">
                            <div class="player-info">
                                <div class="rank-badge">${rankDisplay}</div>
                                <div class="player-img-wrapper">
                                    <img src="${p.img.startsWith('data') ? p.img : '../' + p.img}" alt="img">
                                </div>
                                <div class="player-text-details">
                                    <span class="player-name" ${p.id === myId ? 'style="color: #f7e018;"' : ''}>${p.name}</span>
                                    <span class="player-bid" ${p.id === myId ? 'style="color: #f7e018;"' : ''}>BID: $${p.bid.toLocaleString()}</span>
                                </div>
                            </div>
                            <div class="player-stats-mini">
                                <div class="stat-box"><span class="label">PJ</span><span class="val">${p.matchStats.pj}</span></div>
                                <div class="stat-box highlight"><span class="label">G</span><span class="val">${p.matchStats.g}</span></div>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        // GUARDAR FOTO NUEVA EN FIREBASE
        document.getElementById('profilePicInput').addEventListener('change', (e) => {
            const reader = new FileReader();
            reader.onload = (event) => {
                db.ref('players/' + myId).update({ img: event.target.result });
            };
            reader.readAsDataURL(e.target.files[0]);
        });

        // CONTROL DE INTERFAZ
        document.getElementById('profileIcon').onclick = () => document.getElementById('profilePopup').classList.toggle('active');
        document.getElementById('leaderboardBtn').onclick = () => document.getElementById('leaderboardModal').style.display = 'flex';
        document.getElementById('closeLeaderboard').onclick = () => document.getElementById('leaderboardModal').style.display = 'none';
        
        // Iniciar sincronización
        syncData();
    </script>
</body>
</html>