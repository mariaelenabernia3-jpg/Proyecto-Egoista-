<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Mauricio</title>
    <!-- Enlace al CSS específico de Isagi -->
    <link rel="stylesheet" href="isagi_dashboard_style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="header">
        <div class="position-display">RANKING: <span id="pos-val">--</span></div>
        <div class="profile-icon" id="profileIcon">
            <img src="" id="img-preview" class="profile-pic-preview" style="display:none">
            <i class="fas fa-user profile-default-icon" id="default-icon"></i> 
        </div>
        <div class="profile-popup" id="profilePopup">
            <h3>MAURICIO</h3>
            <p id="bid-val" class="profile-bid-popup">$0</p>
            <p class="profile-level">NIVEL <span id="lvl-val">0</span></p>
            <div class="xp-bar-container">
                <div class="xp-bar-fill" id="xp-bar" style="width:0%"></div>
            </div>
            <span class="xp-text" id="xp-text-val">0/100 XP</span>
            
            <div class="profile-pic-uploader">
                <label for="profilePicInput" class="upload-button">CAMBIAR FOTO</label>
                <input type="file" id="profilePicInput" accept="image/*" style="display:none">
            </div>
        </div>
    </div>

    <main class="main-content">
        <h1>BIENVENIDO MAURICIO</h1>

        <div class="weekly-container">
            <!-- VITRINA DE TROFEOS -->
            <div class="trophy-room">
                <h3>VITRINA DE TROFEOS</h3>
                <div id="trophyList" class="trophy-icons"></div>
            </div>

            <!-- TABLA SEMANAL POR PUNTOS -->
            <div class="weekly-table">
                <h3>BATALLA DE LA SEMANA</h3>
                <div id="weeklyList"></div>
            </div>
        </div>

        <div class="action-bubbles-container">
            <a href="isagi_missions.html" class="action-bubble">MISIONES</a>
            <a href="isagi_stats.html" class="action-bubble">ESTADÍSTICAS</a>
            <div class="action-bubble" id="leaderboardBtn">LEADERBOARD</div>
        </div>
    </main>

    <!-- MODAL DE RANKING GLOBAL POR PUNTOS -->
    <div class="coming-soon-modal" id="leaderboardModal">
        <div class="leaderboard-modal-content">
            <span class="close-button" id="closeLeaderboard">&times;</span>
            <h3 class="leaderboard-title">RANKING MUNDIAL</h3>
            <div id="modalList"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const myId = "Isagi"; 

        const firebaseConfig = {
            apiKey: "AIzaSyDSyHDZzCzqtDfQ7AvtP7or0Lz81HO3A88",
            authDomain: "bluelock-proyecto.firebaseapp.com",
            databaseURL: "https://bluelock-proyecto-default-rtdb.firebaseio.com",
            projectId: "bluelock-proyecto",
            storageBucket: "bluelock-proyecto.firebasestorage.app",
            messagingSenderId: "780939191248",
            appId: "1:780939191248:web:0ba0c191005a7870488fd5",
            measurementId: "G-XE8F4KS1CJ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        db.ref('players').on('value', (snapshot) => {
            const players = snapshot.val();
            if(!players) return;
            const me = players[myId];

            // 1. Datos Personales (Popup)
            document.getElementById('bid-val').textContent = "$" + me.bid.toLocaleString();
            document.getElementById('lvl-val').textContent = me.level;
            document.getElementById('xp-bar').style.width = me.xp + "%";
            document.getElementById('xp-text-val').textContent = me.xp + "/100 XP";

            if(me.img) {
                const imgUrl = me.img.startsWith('data') ? me.img : '../' + me.img;
                document.getElementById('img-preview').src = imgUrl;
                document.getElementById('img-preview').style.display = 'block';
                document.getElementById('default-icon').style.display = 'none';
                document.getElementById('profileIcon').style.backgroundImage = `url(${imgUrl})`;
                document.getElementById('profileIcon').style.backgroundSize = 'cover';
            }

            // 2. Vitrina de Trofeos
            document.getElementById('trophyList').innerHTML = (me.trophies && me.trophies.length > 0) 
                ? me.trophies.map(t => `<div class="trophy-item"><i class="${t.icon}" style="color:${t.color}"></i><span>${t.title}</span></div>`).join('') 
                : '<p style="font-size:0.7em; opacity:0.5;">Sin trofeos ganados.</p>';

            // 3. Tabla Semanal (Goles + Victorias de la semana)
            const sortedWeekly = Object.values(players).sort((a,b) => {
                const ptsA = (a.weeklyStats.g || 0) + (a.weeklyStats.pg || 0);
                const ptsB = (b.weeklyStats.g || 0) + (b.weeklyStats.pg || 0);
                return ptsB - ptsA;
            });
            document.getElementById('weeklyList').innerHTML = sortedWeekly.map((p, i) => {
                const wPts = (p.weeklyStats.g || 0) + (p.weeklyStats.pg || 0);
                return `
                <div class="weekly-list-item ${p.id === myId ? 'highlight' : ''}">
                    <span>${i+1}. ${p.name}</span><span style="font-family:'Orbitron'">${wPts} PTS</span>
                </div>`;
            }).join('');

            // 4. Ranking Global y Modal (Goles + Victorias totales)
            const sortedGlobal = Object.values(players).sort((a, b) => {
                const ptsA = (a.matchStats.g || 0) + (a.matchStats.pg || 0);
                const ptsB = (b.matchStats.g || 0) + (b.matchStats.pg || 0);
                return ptsB - ptsA;
            });
            
            document.getElementById('pos-val').textContent = sortedGlobal.findIndex(p => p.id === myId) + 1;
            
            document.getElementById('modalList').innerHTML = sortedGlobal.map((p, i) => {
                const totalPts = (p.matchStats.g || 0) + (p.matchStats.pg || 0);
                const isFirst = i === 0;
                const rankDisplay = isFirst ? '<i class="fas fa-crown crown-icon"></i>' : i + 1;
                return `
                    <div class="player-row" style="${p.id === myId ? 'border-left: 5px solid gold' : ''}">
                        <div class="player-info">
                            <div class="rank-badge">${rankDisplay}</div>
                            <div class="player-img-wrapper">
                                <img src="${p.img.startsWith('data') ? p.img : '../'+p.img}">
                            </div>
                            <div class="player-text-details">
                                <span class="player-name" ${p.id === myId ? 'style="color:#f7e018"' : ''}>${p.name}</span>
                                <span class="player-bid">BID: $${p.bid.toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="player-stats-mini">
                            <div class="stat-box pts"><span class="label">PTS</span><span class="val">${totalPts}</span></div>
                            <div class="stat-box highlight"><span class="label">G</span><span class="val">${p.matchStats.g}</span></div>
                        </div>
                    </div>`;
            }).join('');
        });

        document.getElementById('profilePicInput').onchange = (e) => {
            const reader = new FileReader();
            reader.onload = (ev) => db.ref('players/' + myId).update({ img: ev.target.result });
            reader.readAsDataURL(e.target.files[0]);
        };

        document.getElementById('profileIcon').onclick = () => document.getElementById('profilePopup').classList.toggle('active');
        document.getElementById('leaderboardBtn').onclick = () => document.getElementById('leaderboardModal').style.display = 'flex';
        document.getElementById('closeLeaderboard').onclick = () => document.getElementById('leaderboardModal').style.display = 'none';
    </script>
</body>
</html>