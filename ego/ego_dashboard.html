<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blue Lock Admin - Ego Jinpachi</title>
    <link rel="stylesheet" href="ego_dashboard_style.css">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="header">
        <div class="header-title">BLUE LOCK PROJECT ADMIN</div>
        <a href="../index.html" class="logout-btn">SALIR</a>
    </div>

    <main class="main-content">
        <h1>CONTROL DE EVOLUCIÓN</h1>
        <div id="egoQuoteDashboard" class="ego-quote-dashboard">"El talento sin pulir es solo basura."</div>

        <!-- 1. GESTIÓN DE PREMIOS Y SEMANA -->
        <div class="admin-section">
            <h2>CIERRE DE SEMANA Y TROFEOS</h2>
            <p style="color: #888; font-size: 0.8em; margin-bottom: 15px;">Selecciona al mejor para darle su trofeo y resetear los puntos de la semana (Goles + Victorias).</p>
            <select id="winnerSelect" class="input-field">
                <option value="">-- Seleccionar Ganador --</option>
            </select>
            <input type="text" id="weekTitle" class="input-field" placeholder="Nombre del Logro (Ej: Ganador Semana 2)">
            <button id="giveTrophyBtn" class="trophy-btn">
                <i class="fas fa-award"></i> ENTREGAR TROFEO Y REINICIAR SEMANA
            </button>
        </div>

        <!-- 2. EDITOR MAESTRO (MODO DIOS) -->
        <div class="admin-section">
            <h2>EDITOR DE JUGADORES</h2>
            <select id="playerSelect" class="input-field">
                <option value="">-- Seleccionar Jugador para Editar --</option>
                <option value="Rin">Ernesto (Rin)</option>
                <option value="Nagi">Kevin (Nagi)</option>
                <option value="Bachira">Yulien (Bachira)</option>
                <option value="Kunigami">Manuel (Kunigami)</option>
                <option value="Isagi">Mauricio (Isagi)</option>
                <option value="Gagamaru">Deadpool (Gagamaru)</option>
            </select>

            <div id="editorForm" style="display: none; width: 100%;">
                <div class="editor-grid">
                    <!-- RENDIMIENTO GLOBAL -->
                    <div class="editor-box">
                        <h3 style="color: var(--highlight-gold);">ESTADÍSTICAS TOTALES</h3>
                        <p style="font-size: 0.7em; color: #888;">El sistema sumará la diferencia automáticamente a la tabla semanal.</p>
                        <div class="input-row"><label>Partidos Jugados</label><input type="number" id="edit_pj" class="input-field min-input"></div>
                        <div class="input-row"><label>Ganados (PG)</label><input type="number" id="edit_pg" class="input-field min-input"></div>
                        <div class="input-row"><label>Perdidos (PP)</label><input type="number" id="edit_pp" class="input-field min-input"></div>
                        <div class="input-row"><label>Goles (G)</label><input type="number" id="edit_g" class="input-field min-input"></div>
                    </div>

                    <!-- HABILIDADES -->
                    <div class="editor-box">
                        <h3 style="color: var(--electric-blue);">HABILIDADES (0-99)</h3>
                        <div class="input-row"><label>Ritmo</label><input type="number" id="edit_ritmo" class="input-field min-input"></div>
                        <div class="input-row"><label>Tiro</label><input type="number" id="edit_tiro" class="input-field min-input"></div>
                        <div class="input-row"><label>Pase</label><input type="number" id="edit_pase" class="input-field min-input"></div>
                        <div class="input-row"><label>Regate</label><input type="number" id="edit_regate" class="input-field min-input"></div>
                        <div class="input-row"><label>Defensa</label><input type="number" id="edit_defensa" class="input-field min-input"></div>
                        <div class="input-row"><label>Físico</label><input type="number" id="edit_fisico" class="input-field min-input"></div>
                    </div>
                </div>
                <button id="savePlayerBtn" class="save-button">GUARDAR Y SINCRONIZAR NUBE</button>
            </div>
        </div>

        <!-- 3. RULETA -->
        <div class="admin-section">
            <h2>RULETA ALEATORIA</h2>
            <button id="generateBtn" class="generate-button">GENERAR EQUIPOS 3 VS 3</button>
            <div id="teamsDisplay" class="teams-container"></div>
        </div>
    </main>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDSyHDZzCzqtDfQ7AvtP7or0Lz81HO3A88",
            authDomain: "bluelock-proyecto.firebaseapp.com",
            databaseURL: "https://bluelock-proyecto-default-rtdb.firebaseio.com",
            projectId: "bluelock-proyecto",
            storageBucket: "bluelock-proyecto.firebasestorage.app",
            messagingSenderId: "780939191248",
            appId: "1:780939191248:web:0ba0c191005a7870488fd5",
            measurementId: "G-XE8F4KS1CJ"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const playersRef = db.ref('players');
        let players = {};

        // 1. CARGAR DATOS
        playersRef.on('value', (snapshot) => {
            players = snapshot.val();
            if (!players) return;

            const winSel = document.getElementById('winnerSelect');
            const savedVal = winSel.value;
            winSel.innerHTML = '<option value="">-- Seleccionar Ganador --</option>';
            Object.values(players).forEach(p => {
                winSel.innerHTML += `<option value="${p.id}">${p.name}</option>`;
            });
            winSel.value = savedVal;
        });

        // 2. EDITOR
        const pSelect = document.getElementById('playerSelect');
        const eForm = document.getElementById('editorForm');

        pSelect.onchange = () => {
            const p = players[pSelect.value];
            if (!p) { eForm.style.display = 'none'; return; }
            eForm.style.display = 'block';

            document.getElementById('edit_pj').value = p.matchStats.pj;
            document.getElementById('edit_pg').value = p.matchStats.pg;
            document.getElementById('edit_pp').value = p.matchStats.pp;
            document.getElementById('edit_g').value = p.matchStats.g;

            document.getElementById('edit_ritmo').value = p.stats.ritmo;
            document.getElementById('edit_tiro').value = p.stats.tiro;
            document.getElementById('edit_pase').value = p.stats.pase;
            document.getElementById('edit_regate').value = p.stats.regate;
            document.getElementById('edit_defensa').value = p.stats.defensa;
            document.getElementById('edit_fisico').value = p.stats.fisico;
        };

        document.getElementById('savePlayerBtn').onclick = () => {
            const id = pSelect.value;
            const p = players[id];

            // Cálculo para la tabla semanal automática (Detectar diferencias)
            const oldTotalGoles = p.matchStats.g;
            const oldTotalPG = p.matchStats.pg;

            const newTotalGoles = parseInt(document.getElementById('edit_g').value) || 0;
            const newTotalPG = parseInt(document.getElementById('edit_pg').value) || 0;

            const difGoles = newTotalGoles - oldTotalGoles;
            const difPG = newTotalPG - oldTotalPG;

            // Actualizar Semanal (Suma los puntos de la semana basándose en el cambio)
            if (!p.weeklyStats) p.weeklyStats = { g: 0, pg: 0, pj: 0 };
            p.weeklyStats.g += difGoles;
            p.weeklyStats.pg += difPG;

            // Actualizar Global
            p.matchStats.pj = parseInt(document.getElementById('edit_pj').value) || 0;
            p.matchStats.pg = newTotalPG;
            p.matchStats.pp = parseInt(document.getElementById('edit_pp').value) || 0;
            p.matchStats.g = newTotalGoles;

            // Actualizar Habilidades
            p.stats.ritmo = parseInt(document.getElementById('edit_ritmo').value) || 0;
            p.stats.tiro = parseInt(document.getElementById('edit_tiro').value) || 0;
            p.stats.pase = parseInt(document.getElementById('edit_pase').value) || 0;
            p.stats.regate = parseInt(document.getElementById('edit_regate').value) || 0;
            p.stats.defensa = parseInt(document.getElementById('edit_defensa').value) || 0;
            p.stats.fisico = parseInt(document.getElementById('edit_fisico').value) || 0;

            // --- AUTO CÁLCULOS ---
            // 1. Dinero (BID): $10M por gol + $5M por victoria
            p.bid = (p.matchStats.g * 10000000) + (p.matchStats.pg * 5000000);
            
            // 2. Media General (Promedio)
            p.stats.media = Math.round((p.stats.ritmo + p.stats.tiro + p.stats.pase + p.stats.regate + p.stats.defensa + p.stats.fisico) / 6);
            
            // 3. XP (Cada gol 5xp, cada victoria 10xp)
            p.xp = (p.matchStats.g * 5) + (p.matchStats.pg * 10);
            while (p.xp >= 100) {
                p.level++;
                p.xp -= 100;
            }

            playersRef.set(players).then(() => alert(`¡${p.name} actualizado!\nNuevos Puntos de la semana sumados: ${difGoles + difPG}`));
        };

        // 3. ENTREGAR TROFEO Y REINICIAR SEMANA
        document.getElementById('giveTrophyBtn').onclick = () => {
            const vid = document.getElementById('winnerSelect').value;
            const title = document.getElementById('weekTitle').value;
            if (!vid || !title) return alert("Faltan datos.");

            if (!players[vid].trophies) players[vid].trophies = [];
            players[vid].trophies.push({ title: title, icon: "fas fa-trophy", color: "#f7e018" });

            // Reiniciar semanal de TODOS (Pone los PTS semanales a 0)
            Object.keys(players).forEach(k => {
                players[k].weeklyStats = { g: 0, pg: 0, pj: 0 };
            });

            playersRef.set(players).then(() => {
                alert("Trofeo entregado y tabla semanal reseteada.");
                document.getElementById('weekTitle').value = "";
            });
        };

        // 4. RULETA FULL AZAR
        document.getElementById('generateBtn').onclick = () => {
            let pool = Object.values(players).sort(() => Math.random() - 0.5);
            document.getElementById('teamsDisplay').innerHTML = `
                <div class="team-card"><h3>EQUIPO A</h3>${pool.slice(0,3).map(p=>`<p class="player-slot">${p.name}</p>`).join('')}</div>
                <div class="team-card" style="border-color:var(--ego-red)"><h3>EQUIPO B</h3>${pool.slice(3,6).map(p=>`<p class="player-slot">${p.name}</p>`).join('')}</div>
            `;
        };
    </script>
</body>
</html>